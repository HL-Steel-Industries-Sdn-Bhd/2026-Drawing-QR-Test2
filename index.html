<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawing + Work Entry Demo</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .container { max-width: 500px; margin: auto; }
  .section { display: none; margin-top: 20px; }
  .scanner-container { width: 100%; height: 300px; border: 2px dashed #888; border-radius: 10px; position: relative; }
  #reader { width: 100%; height: 100%; }
  .gif-container { text-align: center; margin-top: 20px; }
  .gif-container img { width: 150px; }
</style>
</head>
<body>
<div class="container">
  <!-- ===== 隐藏 input 用于电脑 scanner ===== -->
  <input type="text" id="scannerInput" style="opacity:0; position:absolute; left:-9999px;" autofocus>

  <!-- ===== 阶段 1：图纸信息 ===== -->
  <div id="drawingSection" class="section" style="display:block;">
    <h2>Drawing Info</h2>
    <div class="info">
      <p><b>Sales Order No.:</b> SO-009999</p>
      <p><b>Item No.:</b> 20</p>
      <p><b>Customer Name:</b> Fujimak</p>
      <p><b>Item Name:</b> S/S Table</p>
      <p><b>Dimension:</b> L 870mm x W 760mm x H 50mm</p>
      <p><b>Quantity:</b> 1</p>
      <p><b>Unit of Measurement:</b> Set</p>
    </div>
    <p>Please scan your <b>Credential QR Code</b></p>

    <div class="scanner-container" id="scannerContainer">
      <div id="reader"></div>
    </div>

    <div class="gif-container" id="gifContainer">
      <p>Use your scanner to scan the Credential QR Code</p>
      <img src="https://media.giphy.com/media/3o6ZtaO9BZHcOjmErm/giphy.gif" alt="Scanner GIF">
    </div>
  </div>

  <!-- ===== 阶段 2：填工作资料 ===== -->
  <div id="workSection" class="section">
    <h2>Work Entry Page</h2>
    <p id="userDisplay"></p>
    <p>Here you can fill the work data for this drawing.</p>
  </div>
</div>

<script>
function isMobile() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

const scannerContainer = document.getElementById("scannerContainer");
const gifContainer = document.getElementById("gifContainer");
const drawingSection = document.getElementById("drawingSection");
const workSection = document.getElementById("workSection");
const userDisplay = document.getElementById("userDisplay");
const scannerInput = document.getElementById("scannerInput");

function handleCredentialScan(user) {
  // 隐藏图纸信息，显示填工作资料
  drawingSection.style.display = "none";
  workSection.style.display = "block";
  userDisplay.textContent = `Current User: ${user}`;
}

if (isMobile()) {
  // 手机打开，显示摄像头扫码
  scannerContainer.style.display = "block";
  const html5QrcodeScanner = new Html5Qrcode("reader");

  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      console.log("Scanned:", decodedText);
      if(decodedText === "Cyril") {
        html5QrcodeScanner.stop();
        handleCredentialScan("Cyril");
      } else {
        alert("Unknown user QR");
      }
    }
  ).catch(err => {
    console.error(err);
    alert("Camera init failed");
  });

} else {
  // 电脑打开，显示 GIF 提示用 scanner
  gifContainer.style.display = "block";

  // 每次点击页面都 focus 隐藏输入框，保证 scanner 输入能捕获
  document.addEventListener("click", () => scannerInput.focus());

  // 监听 scanner 输入
  scannerInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") {
      const value = scannerInput.value.trim();
      scannerInput.value = "";
      if(value === "Cyril") {
        handleCredentialScan("Cyril");
      }
    }
  });

  // 页面加载后自动 focus 输入框
  window.onload = () => {
    scannerInput.focus();
  };
}
</script>
</body>
</html>
